# 05. 监控资源与管理硬件

## 监控资源

### 进程

#### htop(进程)

一般查看当前用户下最占用cpu（P）和内存（M）的进程

* 命令行

```bash
# 只查看当前用户的进程
$ htop -u $(whoami)
```

* 交互式快捷键

<img src="https://natsu-akatsuki.oss-cn-guangzhou.aliyuncs.com/img/image-20210904001431390.png" alt="image-20210904001431390" style="zoom:50%; " />

* 配置项

<img src="https://natsu-akatsuki.oss-cn-guangzhou.aliyuncs.com/img/image-20210904002516344.png" alt="image-20210904002516344" style="zoom:67%; " />

#### 查看进程树

* 图形化界面（for KDE）

<img src="https://natsu-akatsuki.oss-cn-guangzhou.aliyuncs.com/img/image-20210910181315174.png" alt="image-20210910181315174" style="zoom:50%; " />

* [命令行](https://www.howtoforge.com/linux-pstree-command/)

```bash
$ pstree [user]
-s：查看指定pid的父进程
-u：显示user
-p：显示pid号
-T：隐藏线程
-t：显示线程全称
-a：显示对应的命令行
-g：显示组ID
```

#### 综合

### zenith

* 可从[此处](https://github.com/bvaisvil/zenith/releases)下载相应的deb包(e.g. zenith_0.12.0-1_amd64.deb)

```bash
$ cd ~/application
$ wget -c https://github.com/bvaisvil/zenith/releases/download/0.12.0/zenith_0.12.0-1_amd64.deb
$ sudo dpkg -i zenith_0.12.0-1_amd64.deb
```

* 启动

```bash
$ zenith
```

![image-20210904004618016](https://natsu-akatsuki.oss-cn-guangzhou.aliyuncs.com/img/image-20210904004618016.png)

.. note:: 该可执行文件/命令行能快速提供有价值的信息

## 管理硬件

### v4l2

* 查看相机所有属性

```bash
# v4l2-ctl -d <设备名> -all
$ v4l2-ctl -d /dev/video0 -all
```

<img src="https://natsu-akatsuki.oss-cn-guangzhou.aliyuncs.com/img/3XpxjcSwtiaE2DHP.jpg!thumbnail" alt="img" style="zoom: 67%; " />

* 查看相机支持的像素格式

```bash
# v4l2-ctl --list-formats -d <设备名>
$ v4l2-ctl --list-formats -d /dev/video0
```

<img src="https://natsu-akatsuki.oss-cn-guangzhou.aliyuncs.com/img/HBOuewxlOL2nODH3.jpg!thumbnail" alt="img" style="zoom: 33%; " />

<img src="https://natsu-akatsuki.oss-cn-guangzhou.aliyuncs.com/img/WHtCs1tGSJbLycNu.jpg!thumbnail" alt="img" style="zoom: 33%; " />

* 查看相机支持的分辨率和帧率

```bash
# v4l2-ctl --list-formats-ext -d <设备名>
$ v4l2-ctl --list-formats-ext -d /dev/video2
```

* [手写yuyv转yuv420](http://blog.mchook.cn/2018/03/07/YUYV(YUV422)%20to%20YUV420P/)

### 监控设备温度

```bash
$ sudo apt install lm-sensors
$ watch -n 2 sensors
```

<img src="https://natsu-akatsuki.oss-cn-guangzhou.aliyuncs.com/img/IY7gtxIT4cnCmLb0.png!thumbnail" alt="img" style="zoom:67%; " />

### 查看设备信息

```bash
$ lspci   # pci接口设备信息
$ lsusb   # usb设备信息
$ lshw -c <device_name>  # ls hardware
```

* lshw[可查询的设备](https://ezix.org/project/wiki/HardwareLiSter)：

![img](https://natsu-akatsuki.oss-cn-guangzhou.aliyuncs.com/img/vT62MX2KMPNm9DcH.png!thumbnail)

* 显卡信息显示不完全

![img](https://natsu-akatsuki.oss-cn-guangzhou.aliyuncs.com/img/UX2Bxt3z3hB4vskl.png!thumbnail)

```bash
# 可先更新数据库
$ sudo update-pciids
```

<img src="https://natsu-akatsuki.oss-cn-guangzhou.aliyuncs.com/img/sV507p45ylC7xEa6.png!thumbnail" alt="img" style="zoom:67%; " />

## 实战

### 升级内核以解决硬件驱动无法识别的问题

* [通过官方源升级内核（bash脚本）](https://github.com/pimlie/ubuntu-mainline-kernel.sh)

[非ubuntu21版本，从官方源下载最新内核或有问题（官方源的内核编译时依赖21的库）](https://shimowendang.com/docs/93V6tV6xwywvj6Qy)

![img](https://natsu-akatsuki.oss-cn-guangzhou.aliyuncs.com/img/BL2DG8orSBiQroYp.png!thumbnail)

* 在ubuntu20.04上升级内核到5.10+(ppa)

[可使用20.04的库编译的内核（能用，但内核会有err日志）](https://launchpad.net/~tuxinvader/+archive/ubuntu/lts-mainline)

```bash
$ sudo add-apt-repository ppa:tuxinvader/lts-mainline
$ sudo apt-get update
# e.g. install v5.12
$ sudo apt-get install linux-generic-5.12
```

* (recommend)在ubuntu20.04升级到5.10+(oem)

```bash
$ apt install linux-oem-20.04b
```

#### 拓展资料

* [processors' generation codename](https://www.intel.com/content/www/us/en/design/products-and-solutions/processors-and-chipsets/platform-codenames.html)

* [a discussion for Nvidia GPU](https://forums.developer.nvidia.com/t/ubuntu-mate-20-04-with-rtx-3070-on-ryzen-5900-black-screen-after-boot/167681)
